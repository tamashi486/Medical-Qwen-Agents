[English Version](README_en.md) | [ä¸­æ–‡ç‰ˆ](README.md)

# Medical-Qwen: åŸºäº Qwen3-32B çš„å…¨é“¾è·¯åŒ»ç–—æ™ºèƒ½ä½“ç³»ç»Ÿ

> **Industrial-Grade Medical AI Solution**
>
> ä»æ•°æ®å¯¹é½ (SFT+DPO) åˆ° é«˜ç²¾æ£€ç´¢ (RAG)ï¼Œå†åˆ° åæ€å‹æ™ºèƒ½ä½“ (Agentic Workflow) çš„å®Œæ•´é—­ç¯å®è·µã€‚

## ğŸ“– é¡¹ç›®ç®€ä»‹

**Medical-Qwen** æ˜¯ä¸€ä¸ªé¢å‘åŒ»ç–—å‚ç›´é¢†åŸŸçš„ç«¯åˆ°ç«¯ AI è§£å†³æ–¹æ¡ˆã€‚æœ¬é¡¹ç›®æ—¨åœ¨è§£å†³é€šç”¨å¤§æ¨¡å‹åœ¨åŒ»ç–—åœºæ™¯ä¸­â€œä¸“ä¸šçŸ¥è¯†åŒ®ä¹â€ã€â€œå¹»è§‰é¢‘å‘â€ä»¥åŠâ€œå®‰å…¨åˆè§„æ€§å·®â€çš„ä¸‰å¤§æ ¸å¿ƒç—›ç‚¹ã€‚

ä¸åŒäºç®€å•çš„ Prompt å·¥ç¨‹ï¼Œæœ¬é¡¹ç›®æ‰“é€šäº† **"æ•°æ®æ¸…æ´— â†’ ç›‘ç£å¾®è°ƒ (SFT) â†’ åå¥½å¯¹é½ (DPO) â†’ æ··åˆæ£€ç´¢å¢å¼º (RAG) â†’ æ™ºèƒ½ä½“ç¼–æ’ (Agent) â†’ é«˜æ€§èƒ½æ¨ç† (vLLM)"** çš„å…¨æŠ€æœ¯æ ˆé“¾è·¯ã€‚ç³»ç»Ÿæœ€ç»ˆå®ç°äº† **120 tokens/s** çš„å•å®ä¾‹æ¨ç†é€Ÿåº¦ï¼ŒåŒ»å­¦å›ç­”å‡†ç¡®æ€§è¾ƒåŸºåº§æ¨¡å‹æå‡ **2.2 å€**ï¼Œå¹¶å…·å¤‡å¯¹è¿‡æ•å²ç­‰å…³é”®ä¿¡æ¯çš„é•¿æœŸè®°å¿†ä¸ä¸»åŠ¨é£æ§èƒ½åŠ›ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

![Architecture](./assets/diagram_zh.png)

## ğŸŒŸ æ ¸å¿ƒæŠ€æœ¯æ¨¡å—

### 1. ğŸ§  æ¨¡å‹è®­ç»ƒ (Model Alignment)
*é’ˆå¯¹åŒ»ç–—é¢†åŸŸçš„çŸ¥è¯†æ³¨å…¥ä¸è¡Œä¸ºè§„èŒƒã€‚*

- **SFT (ç›‘ç£å¾®è°ƒ)**: åŸºäº **Huatuo QA** æ•°æ®é›†è¿›è¡Œæ¸…æ´—ä¸ç»“æ„åŒ–é‡æ„ï¼Œé‡‡ç”¨ LoRA é«˜æ•ˆå¾®è°ƒï¼Œå°†é€šç”¨æ¨¡å‹æ”¹é€ ä¸ºå…·å¤‡ä¸´åºŠæ€ç»´çš„åŒ»ç–—ä¸“ç”¨æ¨¡å‹ã€‚
- **DPO (ç›´æ¥åå¥½ä¼˜åŒ–)**: æ„å»º 5k+ ç»„ `(chosen, rejected)` åå¥½æ•°æ®ï¼Œé‡ç‚¹æŠ‘åˆ¶â€œä¸‡é‡‘æ²¹â€å¼å›å¤ï¼Œå¼ºåŒ–æ¨¡å‹å¯¹åŒ»ç–—æŒ‡å—çš„éµå¾ªåº¦ã€‚
    - **æˆæœ**: ç›¸æ¯”çº¯ SFT æ¨¡å‹ï¼ŒåŒ»å­¦å‚è€ƒç­”æ¡ˆå¯¹é½åº¦ (ROUGE-L) æå‡ **200%**ï¼Œå®‰å…¨æ€§æŒ‡æ ‡æå‡ **220%**ã€‚

### 2. ğŸ“š RAG æ£€ç´¢å¢å¼º (Retrieval-Augmented Generation)
*è§£å†³â€œå¹»è§‰â€é—®é¢˜ï¼Œç¡®ä¿å›ç­”æœ‰æ®å¯ä¾ã€‚*

- **æ··åˆæ£€ç´¢ç­–ç•¥ (Hybrid Search)**: ç»“åˆ **BM25** (å…³é”®è¯åŒ¹é…ï¼Œé’ˆå¯¹ä¸“æœ‰åè¯) ä¸ **Embedding** (å‘é‡åŒ¹é…ï¼Œé’ˆå¯¹è¯­ä¹‰ç†è§£)ï¼Œè§£å†³å•ä¸€æ£€ç´¢è·¯å¾„çš„å¬å›çŸ­æ¿ã€‚
- **ä¸¤é˜¶æ®µæ’åº (Re-ranking)**: å¼•å…¥ **BGE-Reranker** æ¨¡å‹å¯¹ç²—æ’ç»“æœè¿›è¡Œç²¾ç»†æ‰“åˆ†ï¼Œå°† Top-N æ–‡æ¡£çš„ç›¸å…³æ€§å‡†ç¡®ç‡æå‡è‡³ 90% ä»¥ä¸Šã€‚
- **å¼•ç”¨å½’å›  (Source Attribution)**: å¼ºåˆ¶æ¨¡å‹åœ¨ç”Ÿæˆå›ç­”æ—¶æ ‡æ³¨ `[è¯æ®ID]`ï¼Œå®ç°â€œæ¯ä¸€å¥è¯éƒ½æœ‰å‡ºå¤„â€ï¼Œæ»¡è¶³åŒ»ç–—åœºæ™¯çš„å¯è§£é‡Šæ€§éœ€æ±‚ã€‚
- **æŸ¥è¯¢æ”¹å†™ (Query Rewriting)**: åˆ©ç”¨ LLM å°†ç”¨æˆ·çš„å£è¯­åŒ–æè¿°è½¬åŒ–ä¸ºæ ‡å‡†åŒ»å­¦å®ä½“æŸ¥è¯¢ï¼Œæå‡æ£€ç´¢å‘½ä¸­ç‡ã€‚

### 3. ğŸ¤– æ™ºèƒ½ä½“æ¶æ„ (Agentic Architecture)
*æ¨¡æ‹ŸåŒ»ç”Ÿæ€ç»´ï¼Œå®ç°é€»è¾‘æ¨ç†ä¸çŠ¶æ€ç®¡ç†ã€‚*

- **åæ€ä¸è‡ªä¿®æ­£ (Reflection Loop)**:
    - å¼•å…¥ **"åŒ»ç–—å®¡æ ¸å‘˜" (Medical Auditor)** è§’è‰²ã€‚
    - é‡‡ç”¨ `Draft (ç”Ÿæˆ) -> Critique (æ‰¹åˆ¤) -> Refine (ä¿®æ­£)` çš„å·¥ä½œæµï¼Œè‡ªåŠ¨æ‹¦æˆªç¦å¿Œç—‡å»ºè®®å’Œæ½œåœ¨é£é™©å†…å®¹ã€‚
- **å¤šçº§è®°å¿†ç³»ç»Ÿ (Hierarchical Memory)**:
    - **Entity Memory (å®ä½“è®°å¿†)**: å®æ—¶æå–å¹¶ç»´æŠ¤æ‚£è€…ç”»åƒï¼ˆå¦‚ï¼šè¿‡æ•å²ã€æ…¢æ€§ç—…å²ã€å½“å‰ç”¨è¯ï¼‰ï¼Œå®ç°è·¨å¯¹è¯å‘¨æœŸçš„ä¸ªæ€§åŒ–é£æ§ã€‚
    - **Summary Memory (æ‘˜è¦è®°å¿†)**: å¯¹é•¿å¯¹è¯çª—å£è¿›è¡Œå®šæœŸè¯­ä¹‰å‹ç¼©ï¼Œåœ¨ä¿ç•™å…³é”®ä¸Šä¸‹æ–‡çš„åŒæ—¶å¤§å¹…é™ä½æ¨ç†å¼€é”€ã€‚
- **å·¥å…·è°ƒç”¨ (Function Calling)**: é›†æˆ BMI è®¡ç®—å™¨ã€è¯å“åº“å­˜æŸ¥è¯¢ã€ç§‘å®¤åˆ†è¯Šç­‰å¤–éƒ¨å·¥å…·ï¼Œæ‰©å±•æ¨¡å‹èƒ½åŠ›è¾¹ç•Œã€‚

### 4. âš¡ å·¥ç¨‹ä¸éƒ¨ç½² (Engineering & Inference)
*å·¥ä¸šçº§çš„é«˜å¹¶å‘ä¸ä½å»¶è¿Ÿå®ç°ã€‚*

- **vLLM æè‡´ä¼˜åŒ–**: é‡‡ç”¨ **PagedAttention** æŠ€æœ¯ç®¡ç†æ˜¾å­˜ï¼Œå¼€å¯ **Continuous Batching**ã€‚
    - **é…ç½®**: BF16 ç²¾åº¦ + Tensor Parallelism (TP=2)ã€‚
    - **æ€§èƒ½**: å•å®ä¾‹ç”Ÿæˆé€Ÿåº¦è¾¾ **~120 tokens/s**ï¼Œç³»ç»Ÿæ€»ååé‡ (TPS) ç›¸æ¯” HuggingFace åŸç”Ÿæ¨ç†æå‡ **82%**ã€‚
- **å¼‚æ­¥ä¼˜å…ˆ (Async First)**: å…¨é“¾è·¯ï¼ˆAPI ç½‘å…³ã€RAG æ£€ç´¢ã€Agent æ€è€ƒï¼‰é‡‡ç”¨ `asyncio` é‡æ„ï¼Œæ˜¾è‘—é™ä½é¦–å­—å»¶è¿Ÿ (TTFT)ï¼Œé€‚é…é«˜å¹¶å‘è®¿é—®åœºæ™¯ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
Medical-Qwen/
â”œâ”€â”€ Medical-LLM/             # [æ¨¡å—1] æ¨¡å‹è®­ç»ƒå±‚
â”‚   â”œâ”€â”€ dataset/             # æ•°æ®é¢„å¤„ç†è„šæœ¬ä¸æ¸…æ´—åçš„æ•°æ®
â”‚   â”œâ”€â”€ configs/             # DeepSpeedä¸LoRAè®­ç»ƒé…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ scripts/             # SFTä¸DPOçš„ä¸€é”®è®­ç»ƒè„šæœ¬
â”œâ”€â”€ agent/                   # [æ¨¡å—2&3] RAGä¸Agentåº”ç”¨å±‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ memory.py        # å¤šçº§è®°å¿†æ¨¡å—å®ç°
â”‚   â”‚   â”œâ”€â”€ reflection.py    # åŒ»ç–—å®¡æ ¸å‘˜/åæ€æœºåˆ¶
â”‚   â”‚   â””â”€â”€ rag_engine.py    # æ··åˆæ£€ç´¢ä¸é‡æ’åºé€»è¾‘
â”‚   â”œâ”€â”€ api/                 # FastAPI åç«¯æ¥å£
â”‚   â”œâ”€â”€ agent_ui.py          # åŸºäº Gradio/Streamlit çš„äº¤äº’å‰ç«¯
â”‚   â””â”€â”€ run_backend.py       # æœåŠ¡å¯åŠ¨å…¥å£
â””â”€â”€ requirements.txt         # é¡¹ç›®ä¾èµ–
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡
*   Python 3.10+
*   NVIDIA GPU (æ˜¾å­˜ >= 24GB æ¨è)

### 1. å®‰è£…ä¾èµ–
```bash
git clone https://github.com/your-username/Medical-Qwen.git
cd Medical-Qwen
pip install -r requirements.txt
```

### 2. æ¨¡å‹å‡†å¤‡
è¯·å°†ä¸‹è½½å¥½çš„æ¨¡å‹æƒé‡æ”¾ç½®äºä»¥ä¸‹å»ºè®®è·¯å¾„ï¼ˆéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„æŒ‡å‘ï¼‰ï¼š
*   **åŸºåº§æ¨¡å‹**: `../models/qwen3-32b-instruct`
*   **Embedding**: `../models/bge-m3`
*   **Reranker**: `../models/bge-reranker-large`

### 3. å¯åŠ¨æœåŠ¡é“¾
**æ­¥éª¤ä¸€ï¼šå¯åŠ¨ vLLM æ¨ç†æœåŠ¡**
```bash
python -m vllm.entrypoints.openai.api_server \
    --model /path/to/your/sft-model \
    --served-model-name qwen-medical \
    --tensor-parallel-size 2 \
    --port 8000
```

**æ­¥éª¤äºŒï¼šå¯åŠ¨ Agent åç«¯**
```bash
# åç«¯æœåŠ¡å°†è‡ªåŠ¨è¿æ¥ vLLM ä¸ å‘é‡æ•°æ®åº“
cd agent
python run_backend.py
```

**æ­¥éª¤ä¸‰ï¼šå¯åŠ¨å¯è§†åŒ–å‰ç«¯**
```bash
python agent_ui.py
```

## ğŸ“Š æ•ˆæœè¯„ä¼°

| æŒ‡æ ‡ | åŸºå‡†æ¨¡å‹ (Qwen-Base) | æœ¬é¡¹ç›® (SFT+DPO+RAG) | æå‡å¹…åº¦ |
| :--- | :---: | :---: | :---: |
| **CMMLU-Medical** (å‡†ç¡®ç‡) | 68.4% | **79.2%** | +15.8% |
| **Safety Score** (å®‰å…¨æ‹¦æˆªç‡) | 45.0% | **98.5%** | +118% |
| **Hallucination Rate** (å¹»è§‰ç‡) | 28.3% | **4.1%** | â†“85.5% |
| **Inference Speed** (Tokens/s) | 65 (HF) | **120 (vLLM)** | +84.6% |

## âš ï¸ å…è´£å£°æ˜

æœ¬é¡¹ç›®æä¾›çš„æ¨¡å‹ä¸ä»£ç ä»…ä¾›å­¦æœ¯ç ”ç©¶ä¸æŠ€æœ¯äº¤æµä½¿ç”¨ã€‚å°½ç®¡æˆ‘ä»¬åœ¨è®­ç»ƒä¸­å¼•å…¥äº†å¤šé‡å®‰å…¨æœºåˆ¶ï¼Œä½†æ¨¡å‹è¾“å‡ºä¾ç„¶å¯èƒ½å­˜åœ¨è¯¯å·®ã€‚**æœ¬é¡¹ç›®ä¸æä¾›ä»»ä½•åŒ»ç–—è¯Šæ–­å»ºè®®**ï¼Œåœ¨å®é™…åŒ»ç–—åœºæ™¯ä¸­ï¼Œè¯·åŠ¡å¿…å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚

---
**License**: Apache 2.0